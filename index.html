<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Selamat Ulang Tahun Detya</title>
  <style>
    :root{
      --sky1:#05060f; --sky2:#0b1330; --sky3:#101b3f;
      --text:#f3f5ff; --muted:rgba(243,245,255,.75);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      color:var(--text);
      overflow:hidden;
      background: radial-gradient(1200px 700px at 50% 30%, var(--sky3), var(--sky2) 45%, var(--sky1) 100%);
    }

    .stars, .stars::before, .stars::after{
      position:absolute; inset:0; content:"";
      background-repeat: repeat; background-size: 220px 220px;
      opacity:.55; pointer-events:none;
      filter: drop-shadow(0 0 2px rgba(255,255,255,.15));
    }
    .stars{
      background-image:
        radial-gradient(2px 2px at 20px 40px, rgba(255,255,255,.9) 50%, transparent 60%),
        radial-gradient(1px 1px at 80px 120px, rgba(255,255,255,.7) 50%, transparent 60%),
        radial-gradient(1.5px 1.5px at 160px 60px, rgba(255,255,255,.8) 50%, transparent 60%),
        radial-gradient(1px 1px at 200px 180px, rgba(255,255,255,.6) 50%, transparent 60%);
      animation: drift 18s linear infinite;
    }
    .stars::before{
      background-image:
        radial-gradient(1px 1px at 40px 160px, rgba(255,255,255,.7) 50%, transparent 60%),
        radial-gradient(2px 2px at 140px 190px, rgba(255,255,255,.8) 50%, transparent 60%),
        radial-gradient(1px 1px at 210px 20px, rgba(255,255,255,.6) 50%, transparent 60%);
      opacity:.45;
      animation: drift 28s linear infinite reverse;
    }
    .stars::after{
      background-image:
        radial-gradient(1px 1px at 110px 30px, rgba(255,255,255,.65) 50%, transparent 60%),
        radial-gradient(1.5px 1.5px at 10px 210px, rgba(255,255,255,.75) 50%, transparent 60%),
        radial-gradient(1px 1px at 190px 90px, rgba(255,255,255,.55) 50%, transparent 60%);
      opacity:.35;
      animation: drift 40s linear infinite;
    }
    @keyframes drift{ from{transform:translate3d(0,0,0)} to{transform:translate3d(-220px,220px,0)} }

    #wrap{position:relative; height:100%; width:100%}
    canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; }

    .ground{
      position:absolute; left:0; right:0; bottom:0; height:38vh;
      background:
        radial-gradient(900px 220px at 50% 10%, rgba(255,204,102,.06), transparent 60%),
        linear-gradient(to top, #04060a 0%, #060a12 45%, rgba(0,0,0,0) 100%);
      pointer-events:none;
    }
    .hills{
      position:absolute; left:-10vw; right:-10vw; bottom:10vh; height:22vh;
      background:
        radial-gradient(60% 120% at 20% 100%, #060a12 60%, transparent 61%),
        radial-gradient(60% 120% at 55% 100%, #070b14 60%, transparent 61%),
        radial-gradient(60% 120% at 85% 100%, #050910 60%, transparent 61%);
      opacity:.95; pointer-events:none;
    }

    .village{
      position:absolute; left:50%; bottom:14vh; transform: translateX(-50%);
      width:min(980px, 92vw); height:22vh; pointer-events:none; opacity:.95;
    }
    .hut{
      position:absolute; bottom:0;
      width:18%; height:48%;
      background:#070a10;
      border-radius:10px 10px 8px 8px;
      box-shadow:0 0 0 1px rgba(255,255,255,.03) inset;
    }
    .hut::before{
      content:"";
      position:absolute; left:-8%; right:-8%; top:-45%;
      height:55%;
      background:#060810;
      transform: skewX(-12deg);
      border-radius:14px 14px 6px 6px;
    }
    .hut .window{
      position:absolute; left:14%; top:34%;
      width:26%; height:22%;
      border-radius:4px;
      background: radial-gradient(circle at 40% 40%, rgba(255,212,138,.95), rgba(255,204,102,.65) 55%, rgba(255,204,102,.1) 75%, transparent 80%);
      box-shadow:0 0 18px rgba(255,204,102,.35), 0 0 40px rgba(255,204,102,.12);
      animation:flicker 2.6s infinite ease-in-out;
    }
    .hut .window.w2{ left:auto; right:14%; top:40%; width:22%; height:18%; animation-duration:3.2s; }
    @keyframes flicker{
      0%,100%{filter:brightness(1);opacity:.9}
      35%{filter:brightness(1.2);opacity:1}
      65%{filter:brightness(.92);opacity:.85}
    }

    .candles{ position:absolute; left:0; right:0; bottom:0; height:18vh; pointer-events:none; overflow:hidden; }
    .candle{
      position:absolute; bottom:3vh;
      width:10px; height:28px;
      border-radius:6px;
      background:linear-gradient(#f6f1e5, #e7ddc7);
      box-shadow:0 0 0 1px rgba(0,0,0,.25) inset;
      transform: translateX(-50%);
    }
    .candle::before{
      content:"";
      position:absolute; left:50%; top:-12px;
      width:18px; height:18px;
      transform: translateX(-50%) rotate(6deg);
      background: radial-gradient(circle at 45% 55%, rgba(255,240,200,1), rgba(255,204,102,.9) 40%, rgba(255,140,40,.25) 70%, transparent 72%);
      animation: flame 1.9s infinite ease-in-out;
    }
    .candle::after{
      content:"";
      position:absolute; left:50%; top:-22px;
      width:120px; height:120px;
      transform: translate(-50%, 0);
      background: radial-gradient(circle, rgba(255,204,102,.22), transparent 62%);
      opacity:.9;
    }
    @keyframes flame{
      0%,100%{ transform: translateX(-50%) rotate(5deg) scale(1) }
      50%{ transform: translateX(-50%) rotate(-6deg) scale(1.07) }
    }

    .ui{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none; padding:22px;
    }
    .panel{
      pointer-events:auto;
      width:min(820px, 92vw);
      padding:18px 18px 16px;
      border-radius:18px;
      background: rgba(10,14,28,.55);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      text-align:center;
    }
    .title{ font-size: clamp(18px, 2.4vw, 26px); letter-spacing:.4px; margin:2px 0 6px; }
    .subtitle{ margin:0 0 14px; color:var(--muted); font-size:14px; line-height:1.35; }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button{
      appearance:none; border:none; border-radius:14px;
      padding:12px 16px; font-weight:650; cursor:pointer;
      color:#0b1022;
      background: linear-gradient(180deg, rgba(255,212,138,1), rgba(255,170,70,1));
      box-shadow:0 10px 30px rgba(255,170,70,.18), 0 2px 0 rgba(0,0,0,.25);
      transition: transform .12s ease, filter .12s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.04); }
    button:active{ transform: translateY(1px); }
    .ghost{ background: rgba(255,255,255,.08); color: var(--text); border: 1px solid rgba(255,255,255,.14); box-shadow:none; }
    .color-btn{ padding:10px 12px; border-radius:999px; }
    .color-btn.active{ outline:2px solid rgba(255,255,255,.65); outline-offset:2px; }
    .hint{ margin-top:10px; font-size:12px; color:rgba(243,245,255,.65); }

    @media (prefers-reduced-motion: reduce){
      .stars, .stars::before, .stars::after, .hut .window, .candle::before{ animation:none !important; }
      button{ transition:none !important; }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="stars" aria-hidden="true"></div>
    <canvas id="fx"></canvas>

    <div class="hills" aria-hidden="true"></div>
    <div class="ground" aria-hidden="true"></div>

    <div class="village" aria-hidden="true">
      <div class="hut" style="left:6%; height:44%; width:18%;"><div class="window"></div><div class="window w2"></div></div>
      <div class="hut" style="left:28%; height:52%; width:20%;"><div class="window"></div><div class="window w2"></div></div>
      <div class="hut" style="left:53%; height:46%; width:19%;"><div class="window"></div><div class="window w2"></div></div>
      <div class="hut" style="left:76%; height:50%; width:20%;"><div class="window"></div><div class="window w2"></div></div>
    </div>

    <div class="candles" id="candles" aria-hidden="true"></div>

    <div class="ui">
      <div class="panel">
        <div class="title">Malam Pedesaan ‚Ä¢ Lilin ‚Ä¢ Kembang Api</div>
        <p class="subtitle">
          Ledakan <b>multi-warna (gradasi)</b> + tulisan kembang api <b>‚ÄúSelamat Ulang Tahun Detya‚Äù</b>.
          Klik langit untuk arahkan roket.
        </p>

        <div class="row">
          <button id="btnFire">üî• Api</button>
          <button id="btnBurst" class="ghost">‚ú® Meledak Sekarang</button>
          <button id="btnClear" class="ghost">üßπ Bersihkan</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="ghost color-btn active" data-scheme="gold">üü° Emas</button>
          <button class="ghost color-btn" data-scheme="sunset">üß° Sunset</button>
          <button class="ghost color-btn" data-scheme="neon">üíö Neon</button>
          <button class="ghost color-btn" data-scheme="ocean">üíô Ocean</button>
          <button class="ghost color-btn" data-scheme="random">üåà Acak</button>
        </div>

        <div class="hint">Keyboard: Space/Enter = Api, C = Bersihkan.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Candles =====
    const candlesEl = document.getElementById("candles");
    const candleCount = 26;
    function seedCandles(){
      candlesEl.innerHTML = "";
      for (let i=0; i<candleCount; i++){
        const c = document.createElement("div");
        c.className = "candle";
        const x = (i/(candleCount-1))*100 + (Math.random()*4-2);
        const y = Math.random()*3;
        c.style.left = x + "%";
        c.style.bottom = (2 + y) + "vh";
        c.style.height = (22 + Math.random()*18) + "px";
        c.style.opacity = (0.75 + Math.random()*0.25);
        candlesEl.appendChild(c);
      }
    }
    seedCandles();
    addEventListener("resize", seedCandles);

    // ===== Canvas sharpness (DPR) =====
    const canvas = document.getElementById("fx");
    const ctx = canvas.getContext("2d", { alpha:true });

    let dpr = 1;
    function resize(){
      dpr = Math.max(1, Math.min(2, devicePixelRatio || 1)); // cap for performance
      canvas.width = Math.floor(innerWidth * dpr);
      canvas.height = Math.floor(innerHeight * dpr);
      canvas.style.width = innerWidth + "px";
      canvas.style.height = innerHeight + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      // hard clear
      ctx.fillStyle = "rgba(0,0,0,1)";
      ctx.fillRect(0,0,innerWidth,innerHeight);
    }
    resize();
    addEventListener("resize", resize);

    // ===== Utils =====
    const rand = (a,b)=> Math.random()*(b-a)+a;
    const clamp = (v,a,b)=> Math.max(a, Math.min(b,v));

    // ===== Color gradient schemes =====
    let colorScheme = "gold";
    const schemes = {
      gold:   [38, 44, 50, 32, 58],
      sunset: [6, 18, 34, 315, 48],
      neon:   [120, 155, 190, 300, 30],
      ocean:  [195, 210, 232, 260, 180]
    };
    function pickHue(i, total){
      if (colorScheme === "random") return rand(0,360);
      const base = schemes[colorScheme] || schemes.gold;
      const h = base[i % base.length];
      // gradasi halus sepanjang ledakan + sedikit noise
      const drift = (i/Math.max(1,total)) * 22;
      return (h + drift + rand(-8,8) + 360) % 360;
    }

    // ===== Particles =====
    const rockets = [];
    const particles = [];
    const grav = 0.055;

    function makeParticle(x,y,vx,vy,r,max,hue,kind="spark",sparkle=false){
      return {x,y,vx,vy,r,life:0,max,hue,kind,sparkle};
    }

    function launchRocket(tx, ty){
      const sx = rand(innerWidth*0.2, innerWidth*0.8);
      const sy = innerHeight + 12;
      rockets.push({
        x:sx, y:sy,
        vx:(tx - sx)/55,
        vy:(ty - sy)/55,
        tx, ty,
        life:0,
        trail:[]
      });
    }

    function drawGlow(x,y,rad,alpha){
      ctx.save();
      ctx.globalAlpha = alpha;
      const g = ctx.createRadialGradient(x,y,0,x,y,rad);
      g.addColorStop(0, "rgba(255,204,102,0.35)");
      g.addColorStop(0.6, "rgba(255,204,102,0.10)");
      g.addColorStop(1, "rgba(255,204,102,0)");
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(x,y,rad,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // ===== Offscreen text sampling (cleaner) =====
    const off = document.createElement("canvas");
    const offCtx = off.getContext("2d", { willReadFrequently:true });

    function textParticles(x, y, text){
      const fontSize = clamp(Math.floor(innerWidth * 0.055), 30, 64);
      const maxW = Math.min(980, innerWidth * 0.92);

      off.width = Math.floor(maxW);
      off.height = Math.floor(fontSize * 2.4);

      offCtx.clearRect(0,0,off.width,off.height);

      // Outline + fill -> hasil sampling lebih ‚Äúsolid‚Äù
      offCtx.textAlign = "center";
      offCtx.textBaseline = "middle";
      offCtx.font = `900 ${fontSize}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial`;

      offCtx.lineWidth = Math.max(6, Math.floor(fontSize * 0.16));
      offCtx.strokeStyle = "#ffffff";
      offCtx.strokeText(text, off.width/2, off.height/2);

      offCtx.fillStyle = "#ffffff";
      offCtx.fillText(text, off.width/2, off.height/2);

      const img = offCtx.getImageData(0,0,off.width,off.height).data;

      // adapt sampling density
      const step = clamp(Math.floor(fontSize / 12), 3, 7);
      const thresholdA = 90;

      const points = [];
      for (let yy=0; yy<off.height; yy+=step){
        for (let xx=0; xx<off.width; xx+=step){
          const idx = (yy*off.width + xx) * 4;
          const a = img[idx+3];
          if (a > thresholdA) points.push({xx,yy});
        }
      }

      // cap points biar performa bagus & tulisan tidak jadi blob
      const MAX_POINTS = 1400;
      let picked = points;
      if (points.length > MAX_POINTS){
        picked = [];
        const stride = Math.ceil(points.length / MAX_POINTS);
        for (let i=0; i<points.length; i+=stride) picked.push(points[i]);
      }

      const originX = x - off.width/2;
      const originY = y - off.height/2;

      const total = picked.length;
      for (let i=0; i<total; i++){
        const p = picked[i];
        const px = originX + p.xx;
        const py = originY + p.yy;

        const angle = Math.atan2(py - y, px - x);
        const sp = rand(0.05, 0.55); // lebih kecil biar kebaca

        const hue = pickHue(i, total);

        particles.push(makeParticle(
          px, py,
          Math.cos(angle)*sp,
          Math.sin(angle)*sp,
          rand(1.2, 2.0),
          rand(88, 120),
          hue,
          "text",
          Math.random() < 0.10
        ));
      }
    }

    function burstMulti(x,y){
      const count = Math.floor(rand(90, 130));
      for (let i=0; i<count; i++){
        const a = (Math.PI*2) * (i/count) + rand(-0.10,0.10);
        const sp = rand(1.2, 4.8);
        const hue = pickHue(i, count);
        particles.push(makeParticle(
          x, y,
          Math.cos(a)*sp,
          Math.sin(a)*sp,
          rand(1.2, 2.6),
          rand(55, 95),
          hue,
          "spark",
          Math.random() < 0.22
        ));
      }
      for (let i=0; i<26; i++){
        particles.push(makeParticle(
          x, y,
          rand(-1.2,1.2),
          rand(-1.2,1.2),
          rand(1.0, 2.2),
          rand(30, 55),
          pickHue(i, 26),
          "spark",
          true
        ));
      }
    }

    function megaExplosion(x,y){
      burstMulti(x,y);
      const textY = clamp(y + clamp(innerHeight*0.06, 26, 60), innerHeight*0.12, innerHeight*0.58);
      textParticles(x, textY, "Selamat Ulang Tahun Detya");
    }

    function clearAll(){
      rockets.length = 0;
      particles.length = 0;
      ctx.fillStyle = "rgba(0,0,0,1)";
      ctx.fillRect(0,0,innerWidth,innerHeight);
    }

    // ===== Animation =====
    let last = performance.now();
    function tick(now){
      const dt = Math.min(2, (now-last)/16.67);
      last = now;

      // fade for trails
      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(0,0,innerWidth,innerHeight);

      drawGlow(innerWidth*0.5, innerHeight*0.78, innerWidth*0.55, 0.20);

      // rockets
      for (let i=rockets.length-1; i>=0; i--){
        const r = rockets[i];
        r.life += dt;

        r.trail.push({x:r.x, y:r.y});
        if (r.trail.length > 18) r.trail.shift();

        r.x += r.vx * (dt*16.67);
        r.y += r.vy * (dt*16.67);

        // trail
        ctx.save();
        for (let t=0; t<r.trail.length; t++){
          const p = r.trail[t];
          const a = t / r.trail.length;
          ctx.globalAlpha = a * 0.55;
          ctx.fillStyle = "rgba(255,210,130,1)";
          ctx.beginPath();
          ctx.arc(p.x, p.y, 1.6 + a*1.4, 0, Math.PI*2);
          ctx.fill();
        }
        ctx.restore();

        // head
        ctx.save();
        ctx.globalAlpha = 0.9;
        ctx.fillStyle = "rgba(255,240,200,1)";
        ctx.beginPath();
        ctx.arc(r.x, r.y, 2.4, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        const dx = r.x - r.tx;
        const dy = r.y - r.ty;
        if ((dx*dx + dy*dy) < 220 || r.life > 80){
          megaExplosion(r.tx, r.ty);
          rockets.splice(i,1);
        }
      }

      // particles
      for (let i=particles.length-1; i>=0; i--){
        const p = particles[i];
        p.life += dt;

        const g = (p.kind === "text") ? (grav * 0.28) : grav;
        p.vy += g * dt * 16.67;

        const damp = (p.kind === "text") ? 0.987 : 0.992;
        p.vx *= Math.pow(damp, dt*16.67);
        p.vy *= Math.pow(damp, dt*16.67);

        p.x += p.vx * dt * 16.67;
        p.y += p.vy * dt * 16.67;

        const t = p.life / p.max;
        const alpha = Math.max(0, 1 - t);

        const sparkleFactor = p.sparkle ? (0.92 + Math.sin(p.life*0.7)*0.18) : 1;
        const rr = p.r * sparkleFactor;

        ctx.save();
        ctx.globalAlpha = alpha;

        ctx.fillStyle = `hsla(${p.hue}, 95%, 70%, 1)`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, rr, 0, Math.PI*2);
        ctx.fill();

        // extra glow
        const glow = (p.kind === "text") ? 0.95 : 0.55;
        ctx.globalAlpha = alpha * glow * 0.55;
        ctx.beginPath();
        ctx.arc(p.x, p.y, rr*3.0, 0, Math.PI*2);
        ctx.fillStyle = `hsla(${p.hue}, 95%, 70%, 0.24)`;
        ctx.fill();

        ctx.restore();

        if (p.life >= p.max) particles.splice(i,1);
      }

      requestAnimationFrame(tick);
    }

    // init clear black
    ctx.fillStyle = "rgba(0,0,0,1)";
    ctx.fillRect(0,0,innerWidth,innerHeight);
    requestAnimationFrame(tick);

    // ===== Controls =====
    const btnFire = document.getElementById("btnFire");
    const btnBurst = document.getElementById("btnBurst");
    const btnClear = document.getElementById("btnClear");

    function fireAt(x,y){
      const ty = clamp(y, innerHeight*0.10, innerHeight*0.52);
      launchRocket(x, ty);
    }

    btnFire.addEventListener("click", ()=> fireAt(innerWidth*0.5, innerHeight*0.28));
    btnBurst.addEventListener("click", ()=> megaExplosion(rand(innerWidth*0.25, innerWidth*0.75), rand(innerHeight*0.14, innerHeight*0.45)));
    btnClear.addEventListener("click", clearAll);

    addEventListener("pointerdown", (e)=>{
      const path = e.composedPath?.() || [];
      if (path.some(el => el && el.tagName === "BUTTON")) return;
      fireAt(e.clientX, e.clientY);
    });

    addEventListener("keydown", (e)=>{
      if (e.code === "Space" || e.code === "Enter"){ e.preventDefault(); fireAt(innerWidth*0.5, innerHeight*0.28); }
      if (e.key.toLowerCase() === "c") clearAll();
    });

    document.querySelectorAll(".color-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        colorScheme = btn.dataset.scheme || "gold";
        document.querySelectorAll(".color-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
      });
    });
  </script>
</body>
</html>
